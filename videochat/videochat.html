<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ØªÙ…Ø§Ø´Ø§ÛŒ Ù…Ø´ØªØ±Ú©</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{background:#0e0e0f;color:#fff;font-family:sans-serif;padding:10px}
video{width:100%;border-radius:12px;border:2px solid gold}
.chat{background:#111;padding:10px;border-radius:10px;margin-top:10px;height:200px;overflow-y:auto}
.msg{background:#222;margin:6px;padding:6px;border-radius:6px}
button{background:gold;border:none;padding:8px;border-radius:6px;font-weight:bold;cursor:pointer}
.hidden{display:none}
input{width:80%;padding:6px;border-radius:6px;border:none;margin-right:6px}
</style>
</head>
<body>

<h2>ğŸ¬ ØªÙ…Ø§Ø´Ø§ÛŒ Ù…Ø´ØªØ±Ú©</h2>

<div id="login">
  <p>ğŸ” Ø±Ù…Ø² ÙˆØ±ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
  <input id="pass" type="password" placeholder="Ø±Ù…Ø²">
  <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
</div>

<div id="room" class="hidden">

<video id="video"></video>

<div id="leaderControls" class="hidden" style="margin-top:10px">
  <button onclick="playVideo()">â–¶ï¸ Ù¾Ø®Ø´</button>
  <button onclick="pauseVideo()">â¸ ØªÙˆÙ‚Ù</button>
</div>

<button onclick="startVoice()" style="margin-top:10px">ğŸ™ ÙˆÛŒØ³â€ŒÚ©Ø§Ù„</button>

<div class="chat">
  <div id="chat"></div>
  <input id="msg" placeholder="Ù¾ÛŒØ§Ù…..." onkeydown="if(event.key==='Enter') sendMsg()">
  <button onclick="sendMsg()">Ø§Ø±Ø³Ø§Ù„</button>
</div>

</div>

<script>
const LEADER_PASS="1111";
const USER_PASS="1234";
let role = null;

const video = document.getElementById("video");
const loginDiv = document.getElementById("login");
const roomDiv = document.getElementById("room");
const leaderControls = document.getElementById("leaderControls");
const chatDiv = document.getElementById("chat");
const msgInput = document.getElementById("msg");

const roomName = new URLSearchParams(location.search).get("room") || "public";
const ws = new WebSocket("wss://softshiraz-room.YOURDOMAIN.workers.dev/"+roomName);

// --- WebSocket ---
ws.onmessage = async e => {
  const d = JSON.parse(e.data);

  if(d.t==="sync"){
    await videoLoaded();
    video.currentTime = d.time;
    if(d.playing) video.play();
    else video.pause();
  }

  if(d.t==="play"){
    await videoLoaded();
    video.currentTime=d.time;
    video.play();
  }

  if(d.t==="pause"){
    await videoLoaded();
    video.currentTime=d.time;
    video.pause();
  }

  if(d.t==="chat") addMsg(d.m);
  if(d.t==="signal") handleSignal(d.data);
};

// --- Login ---
function login(){
  const p = document.getElementById("pass").value;
  if(p===LEADER_PASS) role="leader";
  else if(p===USER_PASS) role="user";
  else return alert("âŒ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");

  loginDiv.classList.add("hidden");
  roomDiv.classList.remove("hidden");

  if(role==="leader"){ leaderControls.classList.remove("hidden"); video.controls=true; }
  else video.controls=false;

  video.src="https://s1.dlserfes.info/dl6/2022/Top.Gun.Maverick.2022/Top.Gun.Maverick.2022.720p.BluRay.Dubbed.FilmKio.mkv?md5=QrowAG4GcVBaXqoq9UI32A&u=288589&expires=1766117902"; // Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆ Ø±Ùˆ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡
}

// --- Chat ---
function sendMsg(){
  if(!msgInput.value) return;
  ws.send(JSON.stringify({t:"chat",m: msgInput.value + (role==="leader"?" ğŸ‘‘":" ğŸ‘¤")}));
  msgInput.value="";
}
function addMsg(t){
  const d=document.createElement("div");
  d.className="msg"; d.textContent=t;
  chatDiv.appendChild(d);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

// --- Leader controls ---
function playVideo(){ if(role!=="leader") return; ws.send(JSON.stringify({t:"play",time:video.currentTime})); }
function pauseVideo(){ if(role!=="leader") return; ws.send(JSON.stringify({t:"pause",time:video.currentTime})); }

// --- Voice ---
let pc;
async function startVoice(){
  pc = new RTCPeerConnection();
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));

  pc.ontrack=e=>{
    const a=document.createElement("audio"); a.srcObject=e.streams[0]; a.autoplay=true;
  };

  pc.onicecandidate=e=>{
    if(e.candidate) ws.send(JSON.stringify({t:"signal",data:{c:e.candidate}}));
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({t:"signal",data:{o:offer}}));
}

async function handleSignal(d){
  if(d.o){
    if(!pc) await startVoice();
    await pc.setRemoteDescription(d.o);
    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);
    ws.send(JSON.stringify({t:"signal",data:{a:ans}}));
  }
  if(d.a) await pc.setRemoteDescription(d.a);
  if(d.c) await pc.addIceCandidate(d.c);
}

// --- ØªØ¶Ù…ÛŒÙ† Ù„ÙˆØ¯ Ø´Ø¯Ù† ÙˆÛŒØ¯ÛŒÙˆ Ù‚Ø¨Ù„ Ø§Ø¹Ù…Ø§Ù„ currentTime ---
function videoLoaded(){
  return new Promise(res => {
    if(video.readyState >= 2) res();
    else video.onloadedmetadata = () => res();
  });
}
</script>

</body>
</html>
