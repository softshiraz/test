<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Watch Party</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:sans-serif}
#lock{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:10}
#users div{display:flex;justify-content:space-between;background:#111;margin:4px;padding:6px}
.msg{background:#222;margin:4px;padding:6px}
.hidden{display:none}
</style>
</head>

<body>

<div id="lock">
  <div>
    <input id="name" placeholder="Ù†Ø§Ù…"><br><br>
    <input id="code" placeholder="Ø±Ù…Ø² Ø§ØªØ§Ù‚"><br><br>
    <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
  </div>
</div>

<video id="video" controls class="hidden">
  <source src="https://s1.dlserfes.info/dl6/2022/Top.Gun.Maverick.2022/Top.Gun.Maverick.2022.720p.BluRay.Dubbed.FilmKio.mkv?md5=QrowAG4GcVBaXqoq9UI32A&u=288589&expires=1766117902">
</video>

<div id="panel" class="hidden">
  <button onclick="startVoice()">ğŸ™</button>
  <button onclick="setTempCode()">ğŸ” Ø±Ù…Ø² Ù…ÙˆÙ‚Øª</button>
</div>

<h4>ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†</h4>
<div id="users"></div>

<h4>ğŸ’¬ Ú†Øª</h4>
<div id="chat"></div>
<input id="msg" onkeydown="if(event.key==='Enter')send()">

<script>
const room = new URLSearchParams(location.search).get("room") || "public";
const ws = new WebSocket("wss://videochat.softshiraz.workers.dev/" + room);
const id = crypto.randomUUID();
let isLeader=false;

ws.onmessage = e=>{
  const d = JSON.parse(e.data);

  if(d.t==="auth"){
    if(!d.ok) return alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡");
    lock.remove();
    video.classList.remove("hidden");
    panel.classList.remove("hidden");
    isLeader=d.leader;
    d.messages.forEach(m=>add(m.name+": "+m.text));
    video.currentTime=d.time;
    if(d.playing) video.play();
    setInterval(()=>{ if(isLeader)
      ws.send(JSON.stringify({t:"sync",time:video.currentTime,playing:!video.paused}));
    },2000);
  }

  if(d.t==="users"){
    users.innerHTML="";
    d.users.forEach(u=>{
      const div=document.createElement("div");
      div.textContent=u.name;
      if(isLeader){
        const b=document.createElement("button");
        b.textContent="Kick";
        b.onclick=()=>ws.send(JSON.stringify({t:"kick",id:u.id}));
        div.appendChild(b);
      }
      users.appendChild(div);
    });
  }

  if(d.t==="chat") add(d.msg.name+": "+d.msg.text);

  if(d.t==="sync"){
    if(!isLeader){
      if(Math.abs(video.currentTime-d.time)>1)
        video.currentTime=d.time;
      d.playing?video.play():video.pause();
    }
  }

  if(d.t==="signal") handleSignal(d.data);
};

function login(){
  ws.send(JSON.stringify({t:"auth",id,name:name.value,code:code.value}));
}
function send(){
  ws.send(JSON.stringify({t:"chat",text:msg.value}));
  msg.value="";
}
function add(t){
  const d=document.createElement("div");
  d.className="msg";d.textContent=t;
  chat.appendChild(d);
}
function setTempCode(){
  const c=prompt("Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯:");
  ws.send(JSON.stringify({t:"setCode",code:c}));
}

/* ---- Voice ---- */
let pc;
async function startVoice(){
  pc=new RTCPeerConnection();
  const s=await navigator.mediaDevices.getUserMedia({audio:true});
  s.getTracks().forEach(t=>pc.addTrack(t,s));
  pc.ontrack=e=>{
    const a=document.createElement("audio");
    a.srcObject=e.streams[0];a.autoplay=true;
  };
  pc.onicecandidate=e=>{
    if(e.candidate) ws.send(JSON.stringify({t:"signal",data:{c:e.candidate}}));
  };
  const o=await pc.createOffer();
  await pc.setLocalDescription(o);
  ws.send(JSON.stringify({t:"signal",data:{o}}));
}
async function handleSignal(d){
  if(d.o){
    if(!pc) await startVoice();
    await pc.setRemoteDescription(d.o);
    const a=await pc.createAnswer();
    await pc.setLocalDescription(a);
    ws.send(JSON.stringify({t:"signal",data:{a}}));
  }
  if(d.a) await pc.setRemoteDescription(d.a);
  if(d.c) await pc.addIceCandidate(d.c);
}
</script>
</body>
</html>
