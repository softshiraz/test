<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پخش فیلم</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #000; 
            color: #fff; 
            font-family: Tahoma, sans-serif; 
            text-align: center;
        }
        #videoContainer { 
            width: 100vw; 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        video { 
            max-width: 100%; 
            max-height: 100%; 
        }
        #passwordOverlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.9); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000;
        }
        #passwordOverlay input { 
            padding: 10px; 
            font-size: 18px; 
            margin-bottom: 20px; 
            width: 200px;
        }
        #passwordOverlay button { 
            padding: 10px 20px; 
            font-size: 18px; 
            cursor: pointer;
        }
        #adminControls { 
            position: absolute; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0,0,0,0.7); 
            padding: 10px; 
            border-radius: 8px; 
            display: none;
        }
        #loading { display: none; color: yellow; font-size: 20px; }
    </style>
</head>
<body>

    <div id="passwordOverlay">
        <h2>برای ورود رمز عبور را وارد کنید</h2>
        <input type="password" id="passwordInput" placeholder="رمز عبور">
        <button onclick="checkPassword()">ورود</button>
        <p id="errorMsg" style="color:red; display:none;">رمز عبور اشتباه است!</p>
    </div>

    <div id="videoContainer">
        <video id="video" playsinline></video>
        <div id="loading">در حال بارگذاری فیلم...</div>
    </div>

    <div id="adminControls">
        <h3>کنترل رهبر</h3>
        <p>لینک فیلم در فایل config.json در GitHub تغییر کند و ذخیره شود.</p>
        <button onclick="reloadConfig()">به‌روزرسانی لینک از GitHub</button>
    </div>

    <script>
        const USER_PASSWORD = "1234";   // رمز کاربر عادی
        const ADMIN_PASSWORD = "1111";  // رمز رهبر

        let isAdmin = false;
        let hlsUrl = "";  // لینک m3u8 از worker

        const CONFIG_URL = "https://raw.githubusercontent.com/USERNAME/REPO/main/config.json"; 
        // <<<--- اینجا USERNAME و REPO را با نام کاربری و ریپازیتوری GitHub خودت عوض کن
        // مثال: https://raw.githubusercontent.com/softshiraz/mysite/main/config.json

        const PROXY_HLS_URL = "https://videochat.softshiraz.workers.dev/stream"; 
        // لینک ثابت پخش از Cloudflare Worker (پروکسی ساده به لینک مستقیم MKV)

        async function fetchConfig() {
            try {
                const response = await fetch(CONFIG_URL + "?t=" + Date.now()); // کش مرورگر را دور بزن
                const data = await response.json();
                return data.videoUrl; // لینک مستقیم MKV که در config.json گذاشتی
            } catch (e) {
                alert("خطا در دریافت لینک از GitHub! فایل config.json را چک کن.");
                return null;
            }
        }

        async function checkPassword() {
            const input = document.getElementById("passwordInput").value;
            const errorMsg = document.getElementById("errorMsg");

            if (input === USER_PASSWORD || input === ADMIN_PASSWORD) {
                if (input === ADMIN_PASSWORD) {
                    isAdmin = true;
                    document.getElementById("adminControls").style.display = "block";
                }
                document.getElementById("passwordOverlay").style.display = "none";
                document.getElementById("loading").style.display = "block";
                await loadVideo();
            } else {
                errorMsg.style.display = "block";
            }
        }

        async function loadVideo() {
            const directUrl = await fetchConfig();
            if (!directUrl) return;

            // لینک پخش ثابت: worker همیشه به آخرین لینک از config اشاره می‌کند
            hlsUrl = PROXY_HLS_URL;

            const video = document.getElementById("video");

            // غیرفعال کردن کنترل‌ها برای کاربر عادی (seek کاملاً غیرفعال)
            if (!isAdmin) {
                video.controls = false;
                video.style.pointerEvents = "none"; // هیچ کلیک یا کنترلی
            } else {
                video.controls = true;
            }

            if (Hls.isSupported()) {
                const hls = new Hls({
                    lowLatencyMode: true,
                    backBufferLength: 0
                });
                hls.loadSource(hlsUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play();
                    document.getElementById("loading").style.display = "none";
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error(data);
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = hlsUrl;
                video.play();
                document.getElementById("loading").style.display = "none";
            }
        }

        async function reloadConfig() {
            if (!isAdmin) return;
            document.getElementById("loading").style.display = "block";
            await loadVideo();
        }

        // CSS برای مخفی کردن کامل seek bar
        const style = document.createElement('style');
        style.innerHTML = `
            video::-webkit-media-controls-timeline { display: none !important; }
            video::-webkit-media-controls-current-time-display { display: none !important; }
            video::-webkit-media-controls-time-remaining-display { display: none !important; }
        `;
        document.head.appendChild(style);
    </script>

</body>
</html>
