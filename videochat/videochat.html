<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>پخش همزمان ویدیو</title>
<style>
body { font-family: Arial, sans-serif; text-align:center; background:#111; color:#fff; }
input, button { padding:8px; margin:5px; font-size:16px; }
#video-container { margin-top:20px; display:none; }
video { width:80%; max-width:800px; border:2px solid #ffd700; border-radius:10px; }
</style>
</head>
<body>

<h2>وارد شوید</h2>
<input type="password" id="password" placeholder="رمز خود را وارد کنید">
<button id="loginBtn">ورود</button>

<div id="video-container">
    <h3 id="roleTitle"></h3>
    <video id="mainVideo" controls></video>
    <div id="leaderControls" style="margin-top:10px; display:none;">
        <button id="playBtn">پخش</button>
        <button id="pauseBtn">توقف</button>
        <input type="number" id="seekInput" placeholder="ثانیه" min="0">
        <button id="seekBtn">رفتن به زمان</button>
    </div>
</div>

<script>
const passwordInput = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const videoContainer = document.getElementById('video-container');
const mainVideo = document.getElementById('mainVideo');
const leaderControls = document.getElementById('leaderControls');
const roleTitle = document.getElementById('roleTitle');
let role = null;

// لینک ویدیوی نمونه (می‌توانید لینک CDN خودتان را قرار دهید)
mainVideo.src = "https://s1.dlserfes.info/dl6/2022/Top.Gun.Maverick.2022/Top.Gun.Maverick.2022.720p.BluRay.Dubbed.FilmKio.mkv?md5=QrowAG4GcVBaXqoq9UI32A&u=288589&expires=1766117902";

loginBtn.addEventListener('click', () => {
    const pass = passwordInput.value;
    if(pass === '1111') {
        role = 'leader';
        roleTitle.textContent = 'شما لیدر هستید';
        leaderControls.style.display = 'block';
    } else if(pass === '1234') {
        role = 'viewer';
        roleTitle.textContent = 'شما کاربر هستید';
    } else {
        alert('رمز اشتباه است!');
        return;
    }
    passwordInput.style.display = 'none';
    loginBtn.style.display = 'none';
    videoContainer.style.display = 'block';
    connectWebSocket();
});

// --------------- WebSocket ----------------
let ws;
function connectWebSocket() {
    ws = new WebSocket("wss://videochat.softshiraz.workers.dev"); // آدرس Worker خودت
    ws.onopen = () => {
        console.log('WebSocket connected');
        ws.send(JSON.stringify({type:'join', role}));
    };
    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if(role === 'viewer') {
            if(data.type === 'play') mainVideo.currentTime = data.time, mainVideo.play();
            if(data.type === 'pause') mainVideo.currentTime = data.time, mainVideo.pause();
            if(data.type === 'seek') mainVideo.currentTime = data.time;
        }
    };
}

// --------------- کنترل لیدر ----------------
if(role === 'leader') {
    document.getElementById('playBtn').addEventListener('click', () => {
        mainVideo.play();
        ws.send(JSON.stringify({type:'play', time: mainVideo.currentTime}));
    });
    document.getElementById('pauseBtn').addEventListener('click', () => {
        mainVideo.pause();
        ws.send(JSON.stringify({type:'pause', time: mainVideo.currentTime}));
    });
    document.getElementById('seekBtn').addEventListener('click', () => {
        const t = parseFloat(document.getElementById('seekInput').value);
        if(!isNaN(t)) {
            mainVideo.currentTime = t;
            ws.send(JSON.stringify({type:'seek', time: t}));
        }
    });
}

// sync زمان لیدر به محض تغییر
if(role === 'leader') {
    mainVideo.addEventListener('timeupdate', () => {
        ws.send(JSON.stringify({type:'timeupdate', time: mainVideo.currentTime}));
    });
}
</script>
</body>
</html>
