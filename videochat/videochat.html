<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ØªÙ…Ø§Ø´Ø§ÛŒ Ù…Ø´ØªØ±Ú©</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{background:#0e0e0f;color:#fff;font-family:sans-serif}
video{width:100%;border-radius:12px;border:2px solid gold}
.chat{background:#111;padding:10px;border-radius:10px;margin-top:10px}
.msg{background:#222;margin:6px;padding:6px;border-radius:6px}
button{background:gold;border:none;padding:8px;border-radius:6px;font-weight:bold}
.hidden{display:none}
</style>
</head>

<body>

<h2>ğŸ¬ ØªÙ…Ø§Ø´Ø§ÛŒ Ù…Ø´ØªØ±Ú©</h2>

<div id="login">
  <p>ğŸ” Ø±Ù…Ø² ÙˆØ±ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
  <input id="pass" type="password" placeholder="Ø±Ù…Ø²">
  <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
</div>

<div id="room" class="hidden">

<video id="video" controls></video>

<div id="leaderControls" class="hidden">
  <button onclick="play()">â–¶ï¸ Ù¾Ø®Ø´</button>
  <button onclick="pause()">â¸ ØªÙˆÙ‚Ù</button>
</div>

<button onclick="startVoice()">ğŸ™ ÙˆÛŒØ³â€ŒÚ©Ø§Ù„</button>

<div class="chat">
  <div id="chat"></div>
  <input id="msg" placeholder="Ù¾ÛŒØ§Ù…..." onkeydown="if(event.key==='Enter')send()">
</div>

</div>

<script>
const LEADER_PASS = "1111";
const USER_PASS   = "1234";

const roomName = new URLSearchParams(location.search).get("room") || "public";
const ws = new WebSocket("wss://softshiraz-room.YOURNAME.workers.dev/" + roomName);

let role = null;
const video = document.getElementById("video");

ws.onmessage = e => {
  const d = JSON.parse(e.data);

  if (d.t === "chat") add(d.m);

  if (d.t === "play") {
    video.currentTime = d.time;
    video.play();
  }

  if (d.t === "pause") {
    video.currentTime = d.time;
    video.pause();
  }

  if (d.t === "signal") handleSignal(d.data);
};

function login(){
  const p = pass.value;
  if (p === LEADER_PASS) role = "leader";
  else if (p === USER_PASS) role = "user";
  else return alert("âŒ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");

  loginDiv.style.display="none";
  roomDiv.classList.remove("hidden");

  if (role === "leader") {
    leaderControls.classList.remove("hidden");
    video.controls = true;
  } else {
    video.controls = false;
  }

  video.src = "https://s1.dlserfes.info/dl6/2022/Top.Gun.Maverick.2022/Top.Gun.Maverick.2022.720p.BluRay.Dubbed.FilmKio.mkv?md5=QrowAG4GcVBaXqoq9UI32A&u=288589&expires=1766117902";
}

function send(){
  ws.send(JSON.stringify({t:"chat",m:msg.value}));
  add(msg.value);
  msg.value="";
}
function add(t){
  const d=document.createElement("div");
  d.className="msg"; d.textContent=t;
  chat.appendChild(d);
}

function play(){
  if(role!=="leader") return;
  ws.send(JSON.stringify({t:"play",time:video.currentTime}));
}
function pause(){
  if(role!=="leader") return;
  ws.send(JSON.stringify({t:"pause",time:video.currentTime}));
}

/* ğŸ™ Voice */
let pc;
async function startVoice(){
  pc = new RTCPeerConnection();
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));

  pc.ontrack = e=>{
    const a=document.createElement("audio");
    a.srcObject=e.streams[0];
    a.autoplay=true;
  };

  pc.onicecandidate = e=>{
    if(e.candidate)
      ws.send(JSON.stringify({t:"signal",data:{c:e.candidate}}));
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({t:"signal",data:{o:offer}}));
}

async function handleSignal(d){
  if(d.o){
    if(!pc) await startVoice();
    await pc.setRemoteDescription(d.o);
    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);
    ws.send(JSON.stringify({t:"signal",data:{a:ans}}));
  }
  if(d.a) await pc.setRemoteDescription(d.a);
  if(d.c) await pc.addIceCandidate(d.c);
}

/* DOM refs */
const loginDiv = document.getElementById("login");
const roomDiv = document.getElementById("room");
const leaderControls = document.getElementById("leaderControls");
</script>

</body>
</html>
